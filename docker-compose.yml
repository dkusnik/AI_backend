services:
  #keycloak:
  #  image: quay.io/keycloak/keycloak:23.0
  #  container_name: keycloak
  #  command: ["start-dev"]
  #  environment:
  #    KEYCLOAK_ADMIN: keycloak
  #    KEYCLOAK_ADMIN_PASSWORD: keycloak_pass
  #    KC_DB: postgres
  #    KC_DB_URL: jdbc:postgresql://host.docker.internal:5432/keycloak
  #    KC_DB_USERNAME: keycloak
  #    KC_DB_PASSWORD: keycloak_pass
  #    KC_PROXY: edge
  #  ports:
  #    - "8080:8080"
  #  extra_hosts:
  #    - "host.docker.internal:host-gateway"

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    expose:
      - "8000"
    env_file:
      - .env.docker
    volumes:
      - ./:/app/    # mounts local code, overrides image
      - static_volume:/app/static
    #depends_on:
    #  - keycloak
    extra_hosts:
      - "host.docker.internal:host-gateway"

  worker_crawl:
    build:
      context: .
      dockerfile: Dockerfile.worker_crawl
    env_file:
      - .env.docker
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./:/app/    # mounts local code, overrides image
      - static_volume:/app/static
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/ai/:/srv/ai/:rw
#    depends_on:
#      - web
    extra_hosts:
      - "host.docker.internal:host-gateway"

  worker_management:
    build:
      context: .
      dockerfile: Dockerfile.worker_management
    env_file:
      - .env.docker
    volumes:
      - ./:/app/    # mounts local code, overrides image
      - /srv/ai/:/srv/ai/:rw
 #   depends_on:
 #     - web
    extra_hosts:
      - "host.docker.internal:host-gateway"

  worker_default:
    build:
      context: .
      dockerfile: Dockerfile.worker_default
    env_file:
      - .env.docker
    volumes:
      - ./:/app/    # mounts local code, overrides image
 #   depends_on:
 #     - web
    extra_hosts:
      - "host.docker.internal:host-gateway"

  worker_task_sync:
    build:
      context: .
      dockerfile: Dockerfile.worker_task_sync
    env_file:
      - .env.docker
    volumes:
      - ./:/app/    # mounts local code, overrides image
 #   depends_on:
 #     - web
    extra_hosts:
      - "host.docker.internal:host-gateway"

  worker_cron:
    build:
      context: .
      dockerfile: Dockerfile.worker_cron
    env_file:
      - .env.docker
    volumes:
      - ./:/app/    # mounts local code, overrides image
 #   depends_on:
 #     - web
    extra_hosts:
      - "host.docker.internal:host-gateway"


  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    ports:
      - "80:80"
    depends_on:
      - web
    volumes:
      - static_volume:/static
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # =====================
  # OutbackCDX (CDX server)
  # =====================
  outbackcdx:
    image: ukwa/outbackcdx:latest
    ports:
      - "8085:8080"
    volumes:
      - /srv/ai/outbackCDX:/cdx-data
    restart: unless-stopped

  # =====================
  # pywb replay service
  # =====================
  pywb_work:
    image: webrecorder/pywb:latest
    ports:
      - "9080:8080"
    environment:
      PYWB_COLLECTIONS_DIR: /webarchive/collections
    volumes:
      - /srv/ai/browsertrix/collections:/webarchive/collections:ro
    restart: unless-stopped

  # =====================
  # pywb – PRODUCTION (with OutbackCDX)
  # =====================
  pywb_prod:
    image: webrecorder/pywb:latest
    depends_on:
      - outbackcdx
    ports:
      - "9081:8080"
    environment:
      PYWB_COLLECTIONS_DIR: /webarchive/collections
      PYWB_CONFIG_FILE: /webarchive/config.yaml
    volumes:
      - /srv/ai/production_collection:/webarchive/collections:ro
      - ./pywb/config.yaml:/webarchive/config.yaml:ro
    restart: unless-stopped

  # =====================
  # pywb – LONG-TERM (preservation)
  # =====================
  pywb_longterm:
    image: webrecorder/pywb:latest
    ports:
      - "9082:8080"
    environment:
      PYWB_COLLECTIONS_DIR: /webarchive/collections
    volumes:
      - /srv/ai/long_term_collections:/webarchive/collections:ro
    restart: unless-stopped

volumes:
  static_volume:
  outbackcdx_data:
